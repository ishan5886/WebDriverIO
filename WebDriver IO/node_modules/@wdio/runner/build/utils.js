"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getInstancesData = exports.sendFailureMessage = exports.filterLogTypes = exports.initialiseInstance = exports.sanitizeCaps = void 0;
const deepmerge_1 = __importDefault(require("deepmerge"));
const logger_1 = __importDefault(require("@wdio/logger"));
const webdriverio_1 = require("webdriverio");
const webdriver_1 = require("webdriver");
const config_1 = require("@wdio/config");
const log = logger_1.default('@wdio/local-runner:utils');
const MERGE_OPTIONS = { clone: false };
const mochaAllHooks = ['"before all" hook', '"after all" hook'];
/**
 * sanitizes wdio config from capability properties
 * @param  {Object} caps  desired session capabilities
 * @return {Object}       sanitized caps
 */
function sanitizeCaps(caps, filterOut) {
    const defaultConfigsKeys = [
        // WDIO config keys
        ...Object.keys(config_1.DEFAULT_CONFIGS()),
        // WebDriver config keys
        ...Object.keys(webdriver_1.DEFAULTS)
    ];
    return Object.keys(caps).filter((key) => (
    /**
     * filter out all wdio config keys
     */
    !defaultConfigsKeys.includes(key) === !filterOut)).reduce((obj, key) => {
        obj[key] = caps[key];
        return obj;
    }, {});
}
exports.sanitizeCaps = sanitizeCaps;
/**
 * initialise browser instance depending whether remote or multiremote is requested
 * @param  {Object}  config        configuration of sessions
 * @param  {Object}  capabilities  desired session capabilities
 * @param  {boolean} isMultiremote isMultiremote
 * @return {Promise}               resolves with browser object
 */
async function initialiseInstance(config, capabilities, isMultiremote) {
    /**
     * check if config has sessionId and attach it to a running session if so
     */
    if (config.sessionId) {
        log.debug(`attach to session with id ${config.sessionId}`);
        config.capabilities = sanitizeCaps(capabilities);
        /**
         * propagate connection details defined by services or user in capabilities
         */
        const { protocol, hostname, port, path } = capabilities;
        return webdriverio_1.attach({ ...config, ...{ protocol, hostname, port, path } });
    }
    if (!isMultiremote) {
        log.debug('init remote session');
        const sessionConfig = {
            ...config,
            ...sanitizeCaps(capabilities, true),
            capabilities: sanitizeCaps(capabilities)
        };
        return webdriverio_1.remote(sessionConfig);
    }
    const options = {};
    log.debug('init multiremote session');
    // @ts-expect-error ToDo(Christian): can be removed?
    delete config.capabilities;
    for (let browserName of Object.keys(capabilities)) {
        options[browserName] = deepmerge_1.default(config, capabilities[browserName], MERGE_OPTIONS);
    }
    const browser = await webdriverio_1.multiremote(options, config);
    for (let browserName of Object.keys(capabilities)) {
        // @ts-ignore allow random global browser names
        global[browserName] = browser[browserName];
    }
    return browser;
}
exports.initialiseInstance = initialiseInstance;
/**
 * Filter logTypes based on filter
 * @param  {string[]} excludeDriverLogs logTypes filter
 * @param  {string[]} driverLogTypes    available driver log types
 * @return {string[]}                   logTypes
 */
function filterLogTypes(excludeDriverLogs, driverLogTypes) {
    let logTypes = [...driverLogTypes];
    if (Array.isArray(excludeDriverLogs)) {
        log.debug('filtering logTypes', logTypes);
        if (excludeDriverLogs.length === 1 && excludeDriverLogs[0] === '*') { // exclude all logTypes
            logTypes = [];
        }
        else {
            logTypes = logTypes.filter(x => !excludeDriverLogs.includes(x)); // exclude specific logTypes
        }
        log.debug('filtered logTypes', logTypes);
    }
    return logTypes;
}
exports.filterLogTypes = filterLogTypes;
/**
 * Send event to WDIOCLInterface if test or before/after all hook failed
 * @param {string} e        event
 * @param {object} payload  payload
 */
function sendFailureMessage(e, payload) {
    if (e === 'test:fail' ||
        (e === 'hook:end' &&
            payload.error &&
            mochaAllHooks.some(hook => payload.title.startsWith(hook)))) {
        process.send({
            origin: 'reporter',
            name: 'printFailureMessage',
            content: payload
        });
    }
}
exports.sendFailureMessage = sendFailureMessage;
/**
 * Gets { sessionId, isW3C, protocol, hostname, port, path, queryParams } of every Multiremote instance
 * @param {object} browser browser
 * @param {boolean} isMultiremote isMultiremote
 * @return {object}
 */
function getInstancesData(browser, isMultiremote) {
    if (!isMultiremote) {
        return;
    }
    const multiRemoteBrowser = browser;
    const instances = {};
    multiRemoteBrowser.instances.forEach((browserName) => {
        const { protocol, hostname, port, path, queryParams } = multiRemoteBrowser[browserName].options;
        const { isW3C, sessionId } = multiRemoteBrowser[browserName];
        instances[browserName] = { sessionId, isW3C, protocol, hostname, port, path, queryParams };
    });
    return instances;
}
exports.getInstancesData = getInstancesData;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsMERBQTZCO0FBQzdCLDBEQUFpQztBQUNqQyw2Q0FBeUQ7QUFDekQseUNBQW9DO0FBQ3BDLHlDQUE4QztBQUk5QyxNQUFNLEdBQUcsR0FBRyxnQkFBTSxDQUFDLDBCQUEwQixDQUFDLENBQUE7QUFFOUMsTUFBTSxhQUFhLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUE7QUFDdEMsTUFBTSxhQUFhLEdBQUcsQ0FBQyxtQkFBbUIsRUFBRSxrQkFBa0IsQ0FBQyxDQUFBO0FBTy9EOzs7O0dBSUc7QUFDSCxTQUFnQixZQUFZLENBQ3hCLElBQW1DLEVBQ25DLFNBQW1CO0lBRW5CLE1BQU0sa0JBQWtCLEdBQUc7UUFDdkIsbUJBQW1CO1FBQ25CLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyx3QkFBZSxFQUFFLENBQUM7UUFDakMsd0JBQXdCO1FBQ3hCLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBUSxDQUFDO0tBQzNCLENBQUE7SUFFRCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBd0MsRUFBRSxFQUFFLENBQUM7SUFDMUU7O09BRUc7SUFDSCxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxHQUFhLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FDN0QsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUNOLEdBQWtDLEVBQ2xDLEdBQXdDLEVBQzFDLEVBQUU7UUFDQSxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ3BCLE9BQU8sR0FBRyxDQUFBO0lBQ2QsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ1YsQ0FBQztBQXZCRCxvQ0F1QkM7QUFFRDs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsa0JB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